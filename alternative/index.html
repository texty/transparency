<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--<link rel="stylesheet" href="css/styles.css">-->
    <link href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700,700i&amp;subset=cyrillic,cyrillic-ext" rel="stylesheet">

</head>
<style>

    @font-face {
        font-family: 'Syntax-Roman';
        src: url("../fonts/SyntaxLTStd-Roman.otf");
    }
    @font-face {
        font-family: 'Syntax-Bold';
        src: url("../fonts/SyntaxLTStd-Bold.otf");
    }

    body{
        margin:0;
        padding:0;
        /*color:#9f9f9f;*/
    }

    #mygrid {
        display:grid;
        grid-template-columns:60% 40%;
    }

    svg {
        grid-column: 1/2;
        display: block;
        margin: 0;
        font-family: 'PT Sans', sans-serif;
        /*border: 1px solid gray;*/
    }


    text {
        color:grey;
        fill:grey;

    }

    text.big-text{
        font-size: 30px;
        font-weight: 400;
    }

    .effect-layer text, text.dummy-text{
        font-size: 12px;
    }



    .point {
        cursor:pointer;
    }
    .bar{
        cursor:pointer;
    }

    .y.axis {
        color:grey;
        font-size: 11px;
        font-family: 'PT Sans', sans-serif;
        font-weight:400;
        text-transform: uppercase;
    }

    .label {
        color:grey;
        font-family: 'PT Sans', sans-serif;
        font-size:10px;
        text-transform: uppercase;
    }

    #theCity {
        margin-top: 50px;
        margin-right: 200px;
        text-align: right;
        font-family: 'PT Sans', sans-serif;
        font-size:20px;
        color:grey;
        text-transform: uppercase;
    }

    div.tooltip {
        position: absolute;
        text-align: left;
        width: 60px;
        height: auto;
        padding: 2px;
        font-family: 'PT Sans', sans-serif;
        font-size:12px;
        color:grey;
        text-transform: uppercase;
        pointer-events: none;
    }


</style>
<body>

<!--<div class="graphic">-->
    <!--<svg class="chart"></svg>-->
<!--</div>-->
<div id="mygrid">
    <svg></svg>
    <div id="bars">
        <p id="theCity"></p>
    </div>
</div>




<script src="lib/jquery-2.1.4.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<!--<script src="https://d3js.org/d3.v4.min.js"></script>-->
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/queue.v1.min.js"></script>

<!--<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>-->
<!--<script src="js/update.js"></script>-->
<script>
    var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

    var my_data;

    function retrieve_my_data(cb) {
        if (my_data) return cb(my_data);

        return d3.csv("data/geocoded2.csv", function (err, data) {
            if (err) throw err;

            data.forEach(function (d) {
                d.value = +d.value;
                d.share = +d.share;
                d.maxV = +d.maxV;
                d.lat = +d.lat;
                d.lon = +d.lon;
            });

            my_data = data;
            if (cb) return cb(data);
            return;
        })
    }


    var width = window.innerWidth * 0.6,
            height = window.innerHeight,
            centered;

    var color = d3.scale.linear()
            .domain([1, 20])
            .clamp(true)
            .range(['#fff', '#409A99']);

    var projection = d3.geo.mercator()
            .scale(2300)
            .center([31, 48])
            .translate([width / 2, height / 2]);



    var path = d3.geo.path()
            .projection(projection);

    var zoom = d3.behavior.zoom()
            .translate([0, 0])
            .scale(1)
            .scaleExtent([1, 8])
            .on("zoom", zoomed);

    var svg = d3.select('svg')
            .attr('width', width)
            .attr('height', height)
            .call(zoom)
            ;

    var g = svg.append('g')
            ;




    var effectLayer = g.append('g')
            .classed('effect-layer', true);

    var mapLayer = g.append('g')
            .classed('map-layer', true);




    // Load map data

    retrieve_my_data(function(data){

            var subset = data.filter(function (d) {
                return d.usage === "Загальний.бал"
            });

            queue()
                    .defer(d3.json, 'data/simplifyed_ukr.geojson')
//                    .defer(d3.json, 'data/simplifyed_regions.geojson')
                    .defer(d3.csv, 'data/geocoded2.csv')
                    .await(makeMyMap);

        var margin = {
            top: 10,
            right: 50,
            bottom: 15,
            left: 300
        };

        var bwidth = 400 - margin.left - margin.right,
                bheight = window.innerHeight / 1.5 - margin.top - margin.bottom;

        var x = d3.scale.linear()
                .range([0, bwidth])
                .domain([0, 100]);

        var y = d3.scale.ordinal()
                .rangeRoundBands([bheight, 0], .1)
                .domain(subset.map(function (d) {
                    return d.usage;
                }));

        //make y axis to show bar names
        var yAxis = d3.svg.axis()
                .scale(y)
                //no tick marks
                .tickSize(0)
                .orient("left");


            function makeMyMap(error, ukr_shape) {

                effectLayer.selectAll("path")
                        .data(ukr_shape.features)
                        .enter()
                        .append("path")
                        .attr("d", path)
                        .attr("id", "ukraine")
                        .attr("fill", "white")
                        .attr("stroke", "#3695d8")
                        .attr("stroke-width", "2px");

//                effectLayer.selectAll("path")
//                        .data(ukr_regions.features)
//                        .enter()
//                        .append("path")
//                        .attr("d", path)
//                        .attr("fill", "white")
//                        .attr("id", "regions")
//                        .attr("stroke", "#3695d8")
//                        .attr("stroke-width", "0.5px");
            }

//        mapLayer.selectAll("circle")
//                    .data(subset).enter()
//                    .append("circle")
//                    .attr("class", "point")
//                    .attr("cx", function (d) {
//                        return projection([d.lon, d.lat])[0];
//                    })
//                    .attr("cy", function (d) {
//                        return projection([d.lon, d.lat])[1];
//                    })
//                    .attr("r", "3px")
//                    .attr("fill", "#3695d8")
//                    .on("click", function(d){
//                        var filter = d.city;
//                        drawBarsSide(filter);
//                    });

        mapLayer.selectAll(".bar")
                .data(subset)
                .enter()
                .append("g")
                .append("rect")
                .attr("transform",function(d) {
                    return "translate("+projection([d.lon,d.lat])+")"
                })
                .attr("height", 7)
                .attr("width", function (d) {
                    return 20;
                })
                .style("fill", "white")
                .style("stroke", "#bdbdbd")
                .on("click", function(d){
                    var filter = d.city;
                    drawBarsSide(filter);
                })
                .on("mouseover", function(d) {
                    div.transition()
                            .duration(200)
                            .style("opacity", .9);
                    div.html(d.city)
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 10) + "px");
                })
                .on("mouseout", function(d) {
                    div.transition()
                            .duration(500)
                            .style("opacity", 0);
                });


        mapLayer.selectAll(".bar")
                .data(subset)
                .enter()
                .append("g")
                .append("rect")
                .attr("transform",function(d) {
                    return "translate("+projection([d.lon,d.lat]) + 5 +")"
                })
                .attr("height", 7)
                .attr("width", function (d) {
                    return d.share / 5;
                })
                .attr("fill", "#3695d8")
                .on("click", function(d){
                    var filter = d.city;
                    drawBarsSide(filter);
                });


//        mapLayer.selectAll("text")
//                .data(subset).enter()
//                .append("text")
//                .attr("class", "label")
//                .attr("x", function (d) {
//                    return projection([d.lon, d.lat])[0] ;
//                })
//                .attr("y", function (d) {
//                    return projection([d.lon, d.lat])[1]  + 16 +"px";
//                })
//                .text(function (d) {
//                    if(d.district === "yes") {
//                        return d.city
//                    }
//
//                     })
//                .attr("fill", "grey");



        function drawBarsOnMap(filter) {
            $(".chart").remove();


            var currentData = data.filter(function(k) {
                return k.usage === filter
            });

            currentData = currentData.sort(function (a,b){ var margin = {
                top: 50,
                right: 50,
                bottom: 15,
                left: 300
            };

            var bwidth = (window.innerWidth * 0.4) - margin.left - margin.right,
                    bheight = window.innerHeight / 2 - margin.top - margin.bottom;
                return d3.descending(+b.value, +a.value)
            });


            var bsvg = d3.select("#bars").append("svg")
                    .attr("width", bwidth + margin.left + margin.right)
                    .attr("height", bheight + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var x = d3.scale.linear()
                    .range([0, bwidth])
                    .domain([0, 100]);

            var y = d3.scale.ordinal()
                    .rangeRoundBands([bheight, 0], .1)
                    .domain(currentData.map(function (d) {
                        return d.usage;
                    }))
                    ;

            //make y axis to show bar names
            var yAxis = d3.svg.axis()
                    .scale(y)
                    //no tick marks
                    .tickSize(0)
                    .orient("left");

//            var gy = bsvg.append("g")
//                    .attr("class", "y axis")
//                    .call(yAxis);

            var bars = g.selectAll(".bar")
                    .data(currentData)
                    .enter()
                    .append("g")
                    .attr("class", "chart")
                    ;


            bars.append("rect")
                    .attr("class", "bar-overlaying")
                    .attr("transform",function(d) { return "translate("+projection([d.lon,d.lat])+")" })

            //                    .attr("y", function (d) {
//                        return y(d.usage);
//                    })
//                    .attr("height", y.rangeBand())
                    .attr("height", 7)
//                    .attr("x", 0)
                    .attr("width", function (d) {
                        return 20;
                    })
                    .style("fill", "white")
                    .style("stroke", "#bdbdbd")
                    .on("click", function(d){
                        var filter = d.city;
                        drawBarsSide(filter);
                    })
                    .on("mouseover", function(d) {
                        div.transition()
                                .duration(200)
                                .style("opacity", .9);
                        div.html(d.city)
                                .style("left", (d3.event.pageX) + "px")
                                .style("top", (d3.event.pageY - 10) + "px");
                    })
                    .on("mouseout", function(d) {
                        div.transition()
                                .duration(500)
                                .style("opacity", 0);
                    });




        //append rects
            bars.append("rect")
                    .attr("class", "bar")
                    .attr("transform",function(d) { return "translate("+projection([d.lon,d.lat])+")" })
//                    .attr("y", function (d) {
//                        return y(d.usage);
//                    })
//                    .attr("height", y.rangeBand())
                    .attr("height", 7)

                    // .attr("x", 0)
                    .attr("width", function (d) {
                        return d.share/5;
                    })
                    .attr("fill", "#3695d8")
                    .on("click", function(d){
                        var filter = d.city;
                        drawBarsSide(filter);
                    })
                    .on("mouseover", function(d) {
                        div.transition()
                                .duration(200)
                                .style("opacity", .9);
                        div.html(d.city)
                                .style("left", (d3.event.pageX) + "px")
                                .style("top", (d3.event.pageY - 10) + "px");
                    })
                    .on("mouseout", function(d) {
                        div.transition()
                                .duration(500)
                                .style("opacity", 0);
                    });

        }



        function drawBarsSide(filter) {
            $("#bars > svg").remove();
            $("#theCity").html(filter);
            var currentData = data.filter(function(k) {
                return k.city === filter && k.usage != "Загальний.бал"
            });

            currentData = currentData.sort(function (a,b){
                return d3.descending(+b.value, +a.value)
            });



            var bsvg = d3.select("#bars").append("svg")
                    .attr("width", bwidth + margin.left + margin.right)
                    .attr("height", bheight + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var x = d3.scale.linear()
                    .range([0, bwidth])
                    .domain([0, 100]);

            var y = d3.scale.ordinal()
                    .rangeRoundBands([bheight, 0], .1)
                    .domain(currentData.map(function (d) {
                        return d.usage;
                    }));

            //make y axis to show bar names
            var yAxis = d3.svg.axis()
                    .scale(y)
                    //no tick marks
                    .tickSize(0)
                    .orient("left");

            var gy = bsvg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis);

            var bars = bsvg.selectAll(".bar")
                    .data(currentData)
                    .enter()
                    .append("g");


            bars.append("rect")
                    .attr("class", "bar-overlaying")
//                    .attr("transform",function(d) { return "translate("+projection([d.lon,d.lat])+")" })

                    .attr("y", function (d) { return y(d.usage); })
                    .attr("x", 0)
                    .attr("height", y.rangeBand())
//                   .attr("height", 10)
                    .attr("width", function (d) {
                        return x(100);
                    })
                    .style("fill", "#EBEBEB")
                    .style("stroke", "#none")
                    .on("click", function(p) {
                        console.log(p.usage);
                        var filter = p.usage;
                        drawBarsOnMap(filter)

                    });



            //append rects
            bars.append("rect")
                    .attr("class", "bar")
//                    .attr("transform",function(d) { return "translate("+projection([d.lon,d.lat])+")" })
                    .attr("y", function (d) { return y(d.usage); })
                    .attr("x", 0)
                    .attr("height", y.rangeBand())
//                    .attr("height", 10)

                    .attr("width", function (d) {
                        return x(d.share);
                    })
                    .attr("fill", "#3695d8")
                    .on("click", function(p) {
                        console.log(p.usage);
                        var filter = p.usage;
                        drawBarsOnMap(filter)

                    });
        }




        });


    function zoomed() {
        g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
        g.select("#ukraine").style("stroke-width", 1.5 / d3.event.scale + "px");
        g.select(".bar").style("stroke-width", 1.5 / d3.event.scale + "px");
//        drawBarsOnMap(filter);
    }


</script>

</body>
</html>
